 AS V1.42 Beta [Bld 102] - source file fel.asm - page 1 - 7/13/2016 18:52:29


       1/       0 :                     ;****************************************************************************************************************
       2/       0 :                     ;****************************************************************************************************************
       3/       0 :                     ;                                                        
       4/       0 :                     ;                                                FEL-1 Disassembly
       5/       0 :                     ;                                                =================
       6/       0 :                     ;                                                        
       7/       0 :                     ;          Original version by RCA 1974. Recommented and converted by Paul Robson (paul@robsons.org.uk)
       8/       0 :                     ;                                                        
       9/       0 :                     ;       Source provided courtesy of the Hagley Museum and Library from documents on "FRED" developments at
      10/       0 :                     ;     RCA, dated 1974-75; "Fred Folder 1", Acc. 2464, Box 919 described as the "Billie Joe Call" Collection,
      11/       0 :                     ;                      accession no. 2464.54.  Hagley Museum & Library, Wilmington, DE 19807
      12/       0 :                     ;                                                        
      13/       0 :                     ;           Many thanks to their Librarians, especially Lucas Clawson, for reproducing these documents
      14/       0 :                     ;                                 for the 1802 (and related) Processor community.
      15/       0 :                     ;                                                        
      16/       0 :                     ;             The original author is not currently known but may well have been Joseph A. Weisbecker.
      17/       0 :                     ;                                                        
      18/       0 :                     ;                       The source format is for Alfred Arnolds open source "AS" assembler.
      19/       0 :                     ;                                                        
      20/       0 :                     ;****************************************************************************************************************
      21/       0 :                     ;                                                        
      22/       0 :                     ;        These hardware notes should not be viewed as definitive, this information is derived from reading
      23/       0 :                     ;                        the above code. A more detailed document is under consideration.
      24/       0 :                     ;                                                        
      25/       0 :                     ;            EF1 is 1 when a keypad byte is available. It is read from INP 0. There is a shift switch.
      26/       0 :                     ;          I think this is set manually. (Implied). Horizontal resolution is set by a toggle switch. The
      27/       0 :                     ;                            monitor code relies on this being in 'single byte' mode.
      28/       0 :                     ;                                                        
      29/       0 :                     ;                     EF2 and EF3 are external tests. EF2 detects tape stop. EF4 In ? Error ?
      30/       0 :                     ;                                                        
      31/       0 :                     ;                           Port 1 is a device selector. 1 Keypad, 2 TV, 3 Tape Device
      32/       0 :                     ;                     Port 2 for keypad it is set to 0/1 for TV to 0/3, for Tape $20 is read.
      33/       0 :                     ;                   Port 3 is some flags bit 2 (4) is the audio/tape out and bit 0 (1) is run.
      34/       0 :                     ;                                    Port 4 is the external control register.
      35/       0 :                     ;                                    Port 6 is an extension port (in and out)
      36/       0 :                     ;                                                        
      37/       0 :                     ;      Clock Frequency can be derived from the tone code. In BJC notes 04 is 360us. This is 160 + 40 + 40 *4
      38/       0 :                     ;            cycles. Hence it is clocked at 1Mhz. All the products in the table (kc x us) come to 1000
      39/       0 :                     ;                                                        
      40/       0 :                     ;****************************************************************************************************************
      41/       0 :                     ;****************************************************************************************************************
      42/       0 :                     
      43/       0 :                                include felinclude.inc
(1)    1/       0 :                     ;****************************************************************************************************************
(1)    2/       0 :                     ;
(1)    3/       0 :                     ;													1802 Includes
(1)    4/       0 :                     ;
(1)    5/       0 :                     ;****************************************************************************************************************
(1)    6/       0 :                     
(1)    7/       0 :                     	cpu 1802
(1)    8/       0 :                     
(1)    9/       0 : =0H                 r0 = 0 															; register definitions
(1)   10/       0 : =1H                 r1 = 1
(1)   11/       0 : =2H                 r2 = 2
(1)   12/       0 : =3H                 r3 = 3
(1)   13/       0 : =4H                 r4 = 4
(1)   14/       0 : =5H                 r5 = 5
(1)   15/       0 : =6H                 r6 = 6
(1)   16/       0 : =7H                 r7 = 7
(1)   17/       0 : =8H                 r8 = 8
 AS V1.42 Beta [Bld 102] - source file fel.asm(felinclude.inc) - page 2 - 7/13/2016 18:52:29


(1)   18/       0 : =9H                 r9 = 9
(1)   19/       0 : =AH                 ra = 10
(1)   20/       0 : =BH                 rb = 11
(1)   21/       0 : =CH                 rc = 12
(1)   22/       0 : =DH                 rd = 13
(1)   23/       0 : =EH                 re = 14
(1)   24/       0 : =FH                 rf = 15
(1)   25/       0 :                     
(1)   26/       0 : =0H                 keypadPort = 0 													; keypad read (in only)
(1)   27/       0 : =1H                 selectDevice = 1 												; select DMA device (tape 3 tv 2 keypad 1)
(1)   28/       0 : =2H                 controlDevice = 2 												; control of selected device
(1)   29/       0 : =3H                 audioControl = 3  												; control tape/audio
(1)   30/       0 : =4H                 externalControl = 4 											; external control register (used in monitor)
(1)   31/       0 :                     
(1)   32/       0 : =6H                 externalBus = 6 												; external bus (in/out)
(1)   33/       0 :                     
(1)   34/       0 : =700H               screen = 0700h													; screen RAM is here.
(1)   35/       0 :                     
(1)   36/       0 : =1H                 devKeypad = 1 													; device IDs for port 1
(1)   37/       0 : =2H                 devTV = 2
(1)   38/       0 : =3H                 devTape = 3
(1)   39/       0 :                     
(1)   40/       0 : =0H                 cKeyOff = 0 													; controls for keyboard, TV and Tape
(1)   41/       0 : =1H                 cKeyOn = 1 														; for port 2.
(1)   42/       0 : =3H                 cTVOn = 3
(1)   43/       0 : =0H                 cTVOff = 0
(1)   44/       0 : =20H                cTapeRead = 20h
(1)   45/       0 :                     
(1)   46/       0 : =4H                 aSpeakerBit = 4 												; bit 2 is speaker out
(1)   47/       0 : =2H                 aTapeBit = 2 													; bit 1 is tape out
(1)   48/       0 : =1H                 aConnect = 1 													; bit 0 seems to be 1 to connect it.
(1)   49/       0 :                     
(1)   50/       0 :                     fel macro 	fw 													; compile FEL-1 instruction in Hi-Low order
(1)   51/       0 :                     	db 	(fw) / 256
(1)   52/       0 :                     	db 	(fw) & 255
(1)   53/       0 :                     	endm
(1)   54/       0 :                     
      44/       0 :                     
      45/       0 :                     start:
      46/       0 : 00                          idl                                                              
      47/       1 : F8 01                       ldi     1                                                        ; Set interrupt, stack
      48/       3 : B1                          phi     r1                                                       ; they are all in Page 1
      49/       4 : B2                          phi     r2                                                       
      50/       5 : B4                          phi     r4                                                       
      51/       6 : B8                          phi     r8                                                       
      52/       7 : F8 19                       ldi     interrupt & 255                                          ; R1 = $119 Interrupt routine
      53/       9 : A1                          plo     r1                                                       
      54/       A : F8 FF                       ldi     stacktop & 255                                           ; R2 = $1FF Stack top
      55/       C : A2                          plo     r2                                                       
      56/       D : F8 3B                       ldi     nextinstruction & 255                                    
      57/       F : A4                          plo     r4                                                       ; R4 = $13B Execute next instruction
      58/      10 : F8 66                       ldi     call02 & 255                                             
      59/      12 : A8                          plo     r8                                                       ; R8 = $166 Call $1nn where nn is next byte
      60/      13 : 90                          ghi     r0                                                       
      61/      14 : A5                          plo     r5                                                       
      62/      15 : F8 84                       ldi     monitor & 255                                            ; R5 = $0B4 "Macro PC"
      63/      17 : B5                          phi     r5                                                       
      64/      18 : D4                          sep     r4                                                       ; go to "Util" in R4
      65/      19 :                     
      66/      19 :                     ;****************************************************************************************************************
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 3 - 7/13/2016 18:52:29


      67/      19 :                     ;                                                        
      68/      19 :                     ;                                                7xxx Instructions
      69/      19 :                     ;                                                        
      70/      19 :                     ;****************************************************************************************************************
      71/      19 :                     
      72/      19 :                     opcode7:
      73/      19 : D8                          sep     r8                                                       ; Fetch A and B from memory
      74/      1A : 73                          db      readabregs & 255                                         
      75/      1B : E6                          sex     r6                                                       ; X points to register X
      76/      1C : 45                          lda     r5                                                       ; fetch low byte
      77/      1D : A3                          plo     r3                                                       ; go there.
      78/      1E :                     ;   
      79/      1E :                     ;   7x1E M(A)->Vx
      80/      1E :                     ;   
      81/      1E : 4A                          lda     ra                                                       ; read M(RA)
      82/      1F : 56                          str     r6                                                       ; save in X
      83/      20 : D4                          sep     r4                                                       
      84/      21 :                     ;   
      85/      21 :                     ;   7x21 M(B)->Vx
      86/      21 :                     ;   
      87/      21 : 4B                          lda     rb                                                       ; read M(RB)
      88/      22 : 56                          str     r6                                                       ; save in X
      89/      23 : D4                          sep     r4                                                       
      90/      24 :                     ;   
      91/      24 :                     ;   7x24 Vx->M(A)
      92/      24 :                     ;   
      93/      24 : 46                          lda     r6                                                       ; get Vx
      94/      25 : 5A                          str     ra                                                       ; write to M(RA)
      95/      26 : D4                          sep     r4                                                       
      96/      27 :                     ;   
      97/      27 :                     ;   7x27 Vx->M(B)
      98/      27 :                     ;   
      99/      27 : 46                          lda     r6                                                       ; get Vx
     100/      28 : 5B                          str     rb                                                       ; write to M(RB)
     101/      29 : D4                          sep     r4                                                       
     102/      2A :                     ;   
     103/      2A :                     ;   7x2A Vx -> A.0
     104/      2A :                     ;   
     105/      2A : F8 11                       ldi     (areg+1) & 255                                           ; point R7 to RA.0
     106/      2C :                     setaddrreg:
     107/      2C : A7                          plo     r7                                                       
     108/      2D : 46                          lda     r6                                                       ; get Vx
     109/      2E : 57                          str     r7                                                       ; write it there.
     110/      2F : D4                          sep     r4                                                       
     111/      30 :                     ;   
     112/      30 :                     ;   7x30 Vx -> A.1
     113/      30 :                     ;   
     114/      30 : F8 10                       ldi     areg & 255                                               ; RA.1 address
     115/      32 : 30 2C                       br      setaddrreg                                               
     116/      34 :                     ;   
     117/      34 :                     ;   7x30 Vx -> B.0
     118/      34 :                     ;   
     119/      34 : F8 13                       ldi     (breg+1) & 255                                           ; RB.0 address
     120/      36 : 30 2C                       br      setaddrreg                                               
     121/      38 :                     ;   
     122/      38 :                     ;   7x38 A.0 -> Vx
     123/      38 :                     ;   
     124/      38 : 8A                          glo     ra                                                       ; RA.0 value
     125/      39 : 56                          str     r6                                                       ; put in X
     126/      3A : D4                          sep     r4                                                       
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 4 - 7/13/2016 18:52:29


     127/      3B :                     ;   
     128/      3B :                     ;   7x3B A.1 -> Vx
     129/      3B :                     ;   
     130/      3B : 9A                          ghi     ra                                                       ; RA.1 value
     131/      3C : 56                          str     r6                                                       ; put in X
     132/      3D : D4                          sep     r4                                                       
     133/      3E :                     ;   
     134/      3E :                     ;   7x3E Shift X left 4
     135/      3E :                     ;   
     136/      3E : D8                          sep     r8                                                       ; Do Vx << 4
     137/      3F : 4D                          db      shiftvxleft4 & 255                                       
     138/      40 : D4                          sep     r4                                                       
     139/      41 :                     ;   
     140/      41 :                     ;   7x41 Shift X Right 4
     141/      41 :                     ;   
     142/      41 : F0                          ldx                                                              ; Read R(X)
     143/      42 : F6                          shr                                                              
     144/      43 : F6                          shr                                                              
     145/      44 : F6                          shr                                                              
     146/      45 : F6                          shr                                                              
     147/      46 : 56                          str     r6                                                       ; write it back
     148/      47 : F6                          shr                                                              
     149/      48 :                     ;   
     150/      48 :                     ;   7x4B Vx Delay (Tape On, Speaker off)
     151/      48 :                     ;   
     152/      48 : E3                          sex     r3                                                       ; X = P = R3
     153/      49 : 46                          lda     r6                                                       ; read R(X)
     154/      4A : BF                          phi     rf                                                       ; put in RF.0
     155/      4B :                     tapedelayloop:
     156/      4B : 63                          out     audiocontrol                                             ; tape on, speaker off.
     157/      4C : 03                          db      atapebit+aconnect                                        
     158/      4D : 2F                          dec     rf                                                       ; dec counter
     159/      4E : 9F                          ghi     rf                                                       ; timed out
     160/      4F : 3A 4B                       bnz     tapedelayloop                                            ; keep going.
     161/      51 : D4                          sep     r4                                                       
     162/      52 :                     ;   
     163/      52 :                     ;   7x52 Convert Vx to 3 digit decimal at A,A+1,A+2
     164/      52 :                     ;   
     165/      52 : F0                          ldx                                                              ; get R(X)
     166/      53 : BF                          phi     rf                                                       ; save in RF.1
     167/      54 : F8 14                       ldi     dectable & 255                                           ; point R7 to the 100,10,1
     168/      56 : A7                          plo     r7                                                       
     169/      57 : 2A                          dec     ra                                                       ; predec RA
     170/      58 :                     nextdigit:
     171/      58 : 1A                          inc     ra                                                       ; A to next cell.
     172/      59 : 93                          ghi     r3                                                       ; D = 0
     173/      5A : 5A                          str     ra                                                       ; clear counter
     174/      5B :                     subtractunit:
     175/      5B : 47                          lda     r7                                                       ; read divisor
     176/      5C : 27                          dec     r7                                                       ; unpick it
     177/      5D : F5                          sd                                                               ; subtract from R(X)
     178/      5E : 3B 68                       bnf     borrowoccurred                                           ; if no borrow then division complete
     179/      60 : 56                          str     r6                                                       ; write it back to R(X)
     180/      61 : 4A                          lda     ra                                                       ; read counter of divisions
     181/      62 : 2A                          dec     ra                                                       ; undo inc
     182/      63 : FC 01                       adi     01                                                       ; inc counter
     183/      65 : 5A                          str     ra                                                       ; write back
     184/      66 : 30 5B                       br      subtractunit                                             ; try to deduct it again.
     185/      68 :                     borrowoccurred:
     186/      68 : 47                          lda     r7                                                       ; get R7 - divider just done and inc R7 to next
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 5 - 7/13/2016 18:52:29


     187/      69 : F6                          shr                                                              ; shift it right
     188/      6A : 3B 58                       bnf     nextdigit                                                ; until found the 1, i.e. have done 1
     189/      6C : 9F                          ghi     rf                                                       ; fix up R6 back
     190/      6D : 56                          str     r6                                                       
     191/      6E : D4                          sep     r4                                                       
     192/      6F :                     ;   
     193/      6F :                     ;   7F6F INC A. Must use 7F6F so R6 points to VF, the byte before A
     194/      6F :                     ;   
     195/      6F : 1A                          inc     ra                                                       ; increment RA
     196/      70 : 16                          inc     r6                                                       ; R6 now points to RA
     197/      71 : 9A                          ghi     ra                                                       ; write it back.
     198/      72 : 56                          str     r6                                                       
     199/      73 : 16                          inc     r6                                                       
     200/      74 : 8A                          glo     ra                                                       
     201/      75 : 56                          str     r6                                                       
     202/      76 : D4                          sep     r4                                                       
     203/      77 : 00                          db      00                                                       
     204/      78 :                     
     205/      78 :                     ;****************************************************************************************************************
     206/      78 :                     ;                                                        
     207/      78 :                     ;                                              Clear Screen Routine
     208/      78 :                     ;                                                        
     209/      78 :                     ;****************************************************************************************************************
     210/      78 :                     
     211/      78 : 93                          ghi     r3                                                       ; RA = $800 (R3.1 = 0)
     212/      79 : AA                          plo     ra                                                       
     213/      7A : F8 08                       ldi     (screen / 256) + 1                                       
     214/      7C : BA                          phi     ra                                                       
     215/      7D :                     clsloop:
     216/      7D : 2A                          dec     ra                                                       ; dec RA
     217/      7E : 93                          ghi     r3                                                       ; D = 0
     218/      7F : 5A                          str     ra                                                       ; clear screen space
     219/      80 : 8A                          glo     ra                                                       ; check RA.0
     220/      81 : 3A 7D                       bnz     clsloop                                                  ; go back if not finished
     221/      83 : D4                          sep     r4                                                       ; next instruction.
     222/      84 :                     
     223/      84 :                     ;****************************************************************************************************************
     224/      84 :                     ;                                                        
     225/      84 :                     ;                                  This is the FEL-1 Boot Code / Micro monitor.
     226/      84 :                     ;                                                        
     227/      84 :                     ;****************************************************************************************************************
     228/      84 :                     
     229/      84 :                     monitor:
     230/      84 : (MACRO)                     fel     06000h                                                   ; stop tape
     230/      84 : 60                          db      (06000H) / 256
     230/      85 : 00                          db      (06000H) & 255
     231/      86 : (MACRO)                     fel     0022fh                                                   ; copy registers to stack space.
     231/      86 : 02                          db      (0022FH) / 256
     231/      87 : 2F                          db      (0022FH) & 255
     232/      88 :                     ;   
     233/      88 :                     ;   Read key 0 for Run, C for Write, A for Read Mem, B for Write Mem
     234/      88 :                     ;   
     235/      88 : (MACRO)                     fel     0e17ah                                                   ; read Byte into V1
     235/      88 : E1                          db      (0E17AH) / 256
     235/      89 : 7A                          db      (0E17AH) & 255
     236/      8A : (MACRO)                     fel     03100h                                                   ; skip next instruction if not 00
     236/      8A : 31                          db      (03100H) / 256
     236/      8B : 00                          db      (03100H) & 255
     237/      8C : (MACRO)                     fel     0f400h                                                   ; if was 00, then run program from 400
     237/      8C : F4                          db      (0F400H) / 256
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 6 - 7/13/2016 18:52:29


     237/      8D : 00                          db      (0F400H) & 255
     238/      8E : (MACRO)                     fel     0310ch                                                   ; if was 0C, then go to write code
     238/      8E : 31                          db      (0310CH) / 256
     238/      8F : 0C                          db      (0310CH) & 255
     239/      90 : (MACRO)                     fel     0f000h+felwritetape                                      
     239/      90 : F0                          db      (0F000H+FELWRITETAPE) / 256
     239/      91 : CA                          db      (0F000H+FELWRITETAPE) & 255
     240/      92 :                     ;   
     241/      92 :                     ;   Read three keystrokes into A
     242/      92 :                     ;   
     243/      92 : (MACRO)                     fel     0025ch                                                   ; turn television on.
     243/      92 : 02                          db      (0025CH) / 256
     243/      93 : 5C                          db      (0025CH) & 255
     244/      94 : (MACRO)                     fel     0007bh                                                   ; clear screen memory
     244/      94 : 00                          db      (0007BH) / 256
     244/      95 : 7B                          db      (0007BH) & 255
     245/      96 : (MACRO)                     fel     0e27ah                                                   ; read byte to V2 (high address nibble)
     245/      96 : E2                          db      (0E27AH) / 256
     245/      97 : 7A                          db      (0E27AH) & 255
     246/      98 : (MACRO)                     fel     07230h                                                   ; write to MSB of A
     246/      98 : 72                          db      (07230H) / 256
     246/      99 : 30                          db      (07230H) & 255
     247/      9A : (MACRO)                     fel     0e27ah                                                   ; read byte to V2 (middle address nibble)
     247/      9A : E2                          db      (0E27AH) / 256
     247/      9B : 7A                          db      (0E27AH) & 255
     248/      9C : (MACRO)                     fel     0e37ah                                                   ; read byte to V3 (low address nibble)
     248/      9C : E3                          db      (0E37AH) / 256
     248/      9D : 7A                          db      (0E37AH) & 255
     249/      9E : (MACRO)                     fel     01000h+felpack                                           ; call pack V2/V3 to V2
     249/      9E : 10                          db      (01000H+FELPACK) / 256
     249/      9F : E2                          db      (01000H+FELPACK) & 255
     250/      A0 : (MACRO)                     fel     0722ah                                                   ; write to LSB of A
     250/      A0 : 72                          db      (0722AH) / 256
     250/      A1 : 2A                          db      (0722AH) & 255
     251/      A2 : (MACRO)                     fel     02900h                                                   ; Clear V9
     251/      A2 : 29                          db      (02900H) / 256
     251/      A3 : 00                          db      (02900H) & 255
     252/      A4 :                     ;   
     253/      A4 :                     ;   Display Address
     254/      A4 :                     ;   
     255/      A4 :                     feldisplay:
     256/      A4 : (MACRO)                     fel     0723bh                                                   ; MSB of A to V2
     256/      A4 : 72                          db      (0723BH) / 256
     256/      A5 : 3B                          db      (0723BH) & 255
     257/      A6 : (MACRO)                     fel     02409h                                                   ; Set V4 = (1,1)
     257/      A6 : 24                          db      (02409H) / 256
     257/      A7 : 09                          db      (02409H) & 255
     258/      A8 : (MACRO)                     fel     01000h+felshow                                           ; unpack and show V2
     258/      A8 : 10                          db      (01000H+FELSHOW) / 256
     258/      A9 : E8                          db      (01000H+FELSHOW) & 255
     259/      AA : (MACRO)                     fel     07238h                                                   ; LSB of A to V2
     259/      AA : 72                          db      (07238H) / 256
     259/      AB : 38                          db      (07238H) & 255
     260/      AC : (MACRO)                     fel     0240bh                                                   ; Set V4 = (3,1)
     260/      AC : 24                          db      (0240BH) / 256
     260/      AD : 0B                          db      (0240BH) & 255
     261/      AE : (MACRO)                     fel     01000h+felshow                                           ; unpack and show V2
     261/      AE : 10                          db      (01000H+FELSHOW) / 256
     261/      AF : E8                          db      (01000H+FELSHOW) & 255
     262/      B0 :                     ;   
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 7 - 7/13/2016 18:52:29


     263/      B0 :                     ;   Display Data
     264/      B0 :                     ;   
     265/      B0 : (MACRO)                     fel     0721eh                                                   ; read contents of Memory(A) to V2
     265/      B0 : 72                          db      (0721EH) / 256
     265/      B1 : 1E                          db      (0721EH) & 255
     266/      B2 : (MACRO)                     fel     02416h                                                   ; Set V4 = (6,2)
     266/      B2 : 24                          db      (02416H) / 256
     266/      B3 : 16                          db      (02416H) & 255
     267/      B4 : (MACRO)                     fel     010ebh                                                   ; unpack and show V2
     267/      B4 : 10                          db      (010EBH) / 256
     267/      B5 : EB                          db      (010EBH) & 255
     268/      B6 :                     ;   
     269/      B6 :                     ;   First time around, increment A to point to next cell, second time around go back to the display address code.
     270/      B6 :                     ;   
     271/      B6 : (MACRO)                     fel     03901h                                                   ; increment A if V9 != 0 (not first time)
     271/      B6 : 39                          db      (03901H) / 256
     271/      B7 : 01                          db      (03901H) & 255
     272/      B8 : (MACRO)                     fel     07f6fh                                                   
     272/      B8 : 7F                          db      (07F6FH) / 256
     272/      B9 : 6F                          db      (07F6FH) & 255
     273/      BA : (MACRO)                     fel     0e27ah                                                   ; get hex key (upper nibble)
     273/      BA : E2                          db      (0E27AH) / 256
     273/      BB : 7A                          db      (0E27AH) & 255
     274/      BC : (MACRO)                     fel     02901h                                                   ; set V9 = 1 so increments next time
     274/      BC : 29                          db      (02901H) / 256
     274/      BD : 01                          db      (02901H) & 255
     275/      BE : (MACRO)                     fel     0310ah                                                   ; been round twice ?
     275/      BE : 31                          db      (0310AH) / 256
     275/      BF : 0A                          db      (0310AH) & 255
     276/      C0 : (MACRO)                     fel     0f000h+feldisplay                                        ; if command was A (read) do next w/o update
     276/      C0 : F0                          db      (0F000H+FELDISPLAY) / 256
     276/      C1 : A4                          db      (0F000H+FELDISPLAY) & 255
     277/      C2 : (MACRO)                     fel     0e37ah                                                   ; get the low nibble
     277/      C2 : E3                          db      (0E37AH) / 256
     277/      C3 : 7A                          db      (0E37AH) & 255
     278/      C4 : (MACRO)                     fel     010e2h                                                   ; call pack V2/V3 to V2
     278/      C4 : 10                          db      (010E2H) / 256
     278/      C5 : E2                          db      (010E2H) & 255
     279/      C6 : (MACRO)                     fel     07224h                                                   ; store V(2) at M->A (e.g. new address)
     279/      C6 : 72                          db      (07224H) / 256
     279/      C7 : 24                          db      (07224H) & 255
     280/      C8 : (MACRO)                     fel     0f000h+feldisplay                                        ; redisplay address and data.
     280/      C8 : F0                          db      (0F000H+FELDISPLAY) / 256
     280/      C9 : A4                          db      (0F000H+FELDISPLAY) & 255
     281/      CA :                     ;   
     282/      CA :                     ;   Write code to tape
     283/      CA :                     ;   
     284/      CA :                     felwritetape:
     285/      CA : (MACRO)                     fel     00268h                                                   ; disable hex keyboard input
     285/      CA : 02                          db      (00268H) / 256
     285/      CB : 68                          db      (00268H) & 255
     286/      CC : (MACRO)                     fel     021ffh                                                   ; set V1 = $FF (5 sec approx)
     286/      CC : 21                          db      (021FFH) / 256
     286/      CD : FF                          db      (021FFH) & 255
     287/      CE : (MACRO)                     fel     07148h                                                   ; delay of this length so stabilises
     287/      CE : 71                          db      (07148H) / 256
     287/      CF : 48                          db      (07148H) & 255
     288/      D0 : (MACRO)                     fel     02140h                                                   ; set V1 = $40 (1 sec approx)
     288/      D0 : 21                          db      (02140H) / 256
     288/      D1 : 40                          db      (02140H) & 255
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 8 - 7/13/2016 18:52:29


     289/      D2 : (MACRO)                     fel     07148h                                                   ; more delay
     289/      D2 : 71                          db      (07148H) / 256
     289/      D3 : 48                          db      (07148H) & 255
     290/      D4 : (MACRO)                     fel     0d210h                                                   ; tone and delay
     290/      D4 : D2                          db      (0D210H) / 256
     290/      D5 : 10                          db      (0D210H) & 255
     291/      D6 : (MACRO)                     fel     07148h                                                   ; delay with that tone (start tone ?)
     291/      D6 : 71                          db      (07148H) / 256
     291/      D7 : 48                          db      (07148H) & 255
     292/      D8 : (MACRO)                     fel     0a000h                                                   ; A = 0
     292/      D8 : A0                          db      (0A000H) / 256
     292/      D9 : 00                          db      (0A000H) & 255
     293/      DA : (MACRO)                     fel     0f000h+felnext                                           ; (patched out)
     293/      DA : F0                          db      (0F000H+FELNEXT) / 256
     293/      DB : DC                          db      (0F000H+FELNEXT) & 255
     294/      DC :                     felnext:
     295/      DC : (MACRO)                     fel     0e3a0h                                                   ; write tape M(A) to end
     295/      DC : E3                          db      (0E3A0H) / 256
     295/      DD : A0                          db      (0E3A0H) & 255
     296/      DE : (MACRO)                     fel     0d210h                                                   ; tone and delay
     296/      DE : D2                          db      (0D210H) / 256
     296/      DF : 10                          db      (0D210H) & 255
     297/      E0 :                     felstop:
     298/      E0 : (MACRO)                     fel     0f000h+felstop                                           ; stop
     298/      E0 : F0                          db      (0F000H+FELSTOP) / 256
     298/      E1 : E0                          db      (0F000H+FELSTOP) & 255
     299/      E2 :                     ;   
     300/      E2 :                     ;   Pack V2/V3 nibbles into a single byte (subroutine)
     301/      E2 :                     ;   
     302/      E2 :                     felpack:
     303/      E2 : (MACRO)                     fel     0723eh                                                   ; Shift V2 left 4 bits
     303/      E2 : 72                          db      (0723EH) / 256
     303/      E3 : 3E                          db      (0723EH) & 255
     304/      E4 : (MACRO)                     fel     08231h                                                   ; V2 = V2 or V3
     304/      E4 : 82                          db      (08231H) / 256
     304/      E5 : 31                          db      (08231H) & 255
     305/      E6 : (MACRO)                     fel     0026eh                                                   ; return
     305/      E6 : 02                          db      (0026EH) / 256
     305/      E7 : 6E                          db      (0026EH) & 255
     306/      E8 :                     ;   
     307/      E8 :                     ;   Unpack V2 into 2 digits and display at V4 (subroutine)
     308/      E8 :                     ;   
     309/      E8 :                     felshow:
     310/      E8 : (MACRO)                     fel     0b300h                                                   ; point B to $300
     310/      E8 : B3                          db      (0B300H) / 256
     310/      E9 : 00                          db      (0B300H) & 255
     311/      EA : (MACRO)                     fel     0230fh                                                   ; V3 = 0Fh
     311/      EA : 23                          db      (0230FH) / 256
     311/      EB : 0F                          db      (0230FH) & 255
     312/      EC : (MACRO)                     fel     08322h                                                   ; And out lowest nibble into V3
     312/      EC : 83                          db      (08322H) / 256
     312/      ED : 22                          db      (08322H) & 255
     313/      EE : (MACRO)                     fel     07241h                                                   ; Shift V2 right 4, now has highest nibble
     313/      EE : 72                          db      (07241H) / 256
     313/      EF : 41                          db      (07241H) & 255
     314/      F0 : (MACRO)                     fel     07334h                                                   ; B = $03<low>
     314/      F0 : 73                          db      (07334H) / 256
     314/      F1 : 34                          db      (07334H) & 255
     315/      F2 : (MACRO)                     fel     07321h                                                   ; Read Mem(B) -> V3, addr of gfx data
     315/      F2 : 73                          db      (07321H) / 256
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 9 - 7/13/2016 18:52:29


     315/      F3 : 21                          db      (07321H) & 255
     316/      F4 : (MACRO)                     fel     09345h                                                   ; Draw V3 pattern at cell V4
     316/      F4 : 93                          db      (09345H) / 256
     316/      F5 : 45                          db      (09345H) & 255
     317/      F6 : (MACRO)                     fel     054ffh                                                   ; point to previous cell
     317/      F6 : 54                          db      (054FFH) / 256
     317/      F7 : FF                          db      (054FFH) & 255
     318/      F8 : (MACRO)                     fel     07234h                                                   ; B = $03<high>
     318/      F8 : 72                          db      (07234H) / 256
     318/      F9 : 34                          db      (07234H) & 255
     319/      FA : (MACRO)                     fel     07221h                                                   ; Read Mem(B) -> V2, addr of gfx data
     319/      FA : 72                          db      (07221H) / 256
     319/      FB : 21                          db      (07221H) & 255
     320/      FC : (MACRO)                     fel     09245h                                                   ; Draw V2 pattern at cell V4
     320/      FC : 92                          db      (09245H) / 256
     320/      FD : 45                          db      (09245H) & 255
     321/      FE : (MACRO)                     fel     0026eh                                                   ; return
     321/      FE : 02                          db      (0026EH) / 256
     321/      FF : 6E                          db      (0026EH) & 255
     322/     100 :                     
     323/     100 :                     ;****************************************************************************************************************
     324/     100 :                     ;                                                        
     325/     100 :                     ;                                       Register Area and Conversion table
     326/     100 :                     ;                                                        
     327/     100 :                     ;****************************************************************************************************************
     328/     100 :                     
     329/     100 :                     registers:
     330/     100 : 00 00 00 00                 db      0,0,0,0                                                  ; V0-VF
     331/     104 : 00 00 00 00                 db      0,0,0,0                                                  
     332/     108 : 00 00 00 00                 db      0,0,0,0                                                  
     333/     10C : 00 00 00 00                 db      0,0,0,0                                                  
     334/     110 :                     areg:
     335/     110 : 00 00                       db      0,0                                                      ; A
     336/     112 :                     breg:
     337/     112 : 00 00                       db      0,0                                                      ; B
     338/     114 :                     
     339/     114 :                     dectable:
     340/     114 : 64                          db      100                                                      ; dividers.
     341/     115 : 0A                          db      10                                                       
     342/     116 : 01                          db      1                                                        
     343/     117 :                     
     344/     117 :                     ;****************************************************************************************************************
     345/     117 :                     ;                                                        
     346/     117 :                     ;                                               Interrupt Routine.
     347/     117 :                     ;                   Sets up R0 to point to display at $700 and decrements VD,VE,VF if non-zero.
     348/     117 :                     ;                                                        
     349/     117 :                     ;****************************************************************************************************************
     350/     117 :                     
     351/     117 :                     exitinterrupt:
     352/     117 : 42                          lda     r2                                                       ; pop D off the stack
     353/     118 : 70                          ret                                                              ; return re-enabling interrupts.
     354/     119 :                     interrupt:
     355/     119 : 22                          dec     r2                                                       ; save T on Stack
     356/     11A : 78                          sav                                                              
     357/     11B : 22                          dec     r2                                                       ; save D on Stack
     358/     11C : 52                          str     r2                                                       ; Save on stack.
     359/     11D :                     
     360/     11D : F8 07                       ldi     screen/256                                               ; set R0 (display pointer) to $700
     361/     11F : B0                          phi     r0                                                       
     362/     120 : F8 00                       ldi     screen&255                                               
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 10 - 7/13/2016 18:52:29


     363/     122 : A0                          plo     r0                                                       
     364/     123 :                     
     365/     123 : 19                          inc     r9                                                       ; increment R9 (timer ?)
     366/     124 :                     
     367/     124 : 86                          glo     r6                                                       ; get R6
     368/     125 : BD                          phi     rd                                                       ; save in RD.1
     369/     126 :                     
     370/     126 : F8 0D                       ldi     (registers + 0dh) & 255                                  ; point to Vd
     371/     128 : A6                          plo     r6                                                       
     372/     129 :                     timerupdateloop:
     373/     129 : 46                          lda     r6                                                       ; read R6 (VD Timer first time around)
     374/     12A : 26                          dec     r6                                                       ; fix up R6
     375/     12B : 32 31                       bz      nexttimer                                                
     376/     12D : AD                          plo     rd                                                       ; save in RD.0
     377/     12E : 2D                          dec     rd                                                       ; decrement it (so we don't change DF)
     378/     12F : 8D                          glo     rd                                                       ; recover it
     379/     130 : 56                          str     r6                                                       ; save timer now updated
     380/     131 :                     nexttimer:
     381/     131 : 16                          inc     r6                                                       ; point to next timer
     382/     132 : 86                          glo     r6                                                       ; get low byte
     383/     133 : FB 10                       xri     (registers+10h) & 255                                    ; done all timers
     384/     135 : 3A 29                       bnz     timerupdateloop                                          ; if not, go back round again.
     385/     137 : 9D                          ghi     rd                                                       ; get RD.1, fix R6 back up again.
     386/     138 : A6                          plo     r6                                                       
     387/     139 : 30 17                       br      exitinterrupt                                            ; and go back to exit the routine.
     388/     13B :                     
     389/     13B :                     ;****************************************************************************************************************
     390/     13B :                     ;                                                        
     391/     13B :                     ;            Main execution loop, run in R4. Sets up R6 (X) R7 (Y) and calls code from table at 01C0h
     392/     13B :                     ;                                                        
     393/     13B :                     ;****************************************************************************************************************
     394/     13B :                     
     395/     13B :                     nextinstruction:
     396/     13B : 94                          ghi     r4                                                       ; D = 1
     397/     13C : B6                          phi     r6                                                       ; Set R6,R7,RC High to Page 1.
     398/     13D : B7                          phi     r7                                                       
     399/     13E : BC                          phi     rc                                                       
     400/     13F :                     
     401/     13F : 45                          lda     r5                                                       ; Read R5 (instruction High)
     402/     140 : AC                          plo     rc                                                       ; Save in RC.0
     403/     141 : FA 0F                       ani     0fh                                                      ; get the X register number
     404/     143 : A6                          plo     r6                                                       ; R6 now points to Register X.
     405/     144 :                     
     406/     144 : 8C                          glo     rc                                                       ; get the instruction High
     407/     145 : F6                          shr                                                              ; shift right four times.
     408/     146 : F6                          shr                                                              
     409/     147 : F6                          shr                                                              
     410/     148 : F6                          shr                                                              ; instruction code in D
     411/     149 : 32 60                       bz      opcode0                                                  ; if zero, its a machine language
     412/     14B : F9 C0                       ori     instructionvector & 255                                  ; OR with $C0
     413/     14D : AC                          plo     rc                                                       ; Put in RC.0  now points to vector table
     414/     14E :                     
     415/     14E : 45                          lda     r5                                                       ; Read low byte of instruction
     416/     14F : 25                          dec     r5                                                       ; Point it back to R5
     417/     150 : F6                          shr                                                              ; shift right four times
     418/     151 : F6                          shr                                                              
     419/     152 : F6                          shr                                                              
     420/     153 : F6                          shr                                                              ; D now contains the Y register number
     421/     154 : A7                          plo     r7                                                       ; R7 now points to Register Y.
     422/     155 :                     
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 11 - 7/13/2016 18:52:29


     423/     155 : 4C                          lda     rc                                                       ; Read High byte of program
     424/     156 : B3                          phi     r3                                                       ; save in R3.1
     425/     157 : 8C                          glo     rc                                                       ; get low byte of RC
     426/     158 : FC 0F                       adi     0fh                                                      ; point to low address (+1 already)
     427/     15A : AC                          plo     rc                                                       ; write it back
     428/     15B : 4C                          lda     rc                                                       ; get low byte of address
     429/     15C :                     execr3:
     430/     15C : A3                          plo     r3                                                       ; save in R3.0, now has code address
     431/     15D : D3                          sep     r3                                                       ; and call it
     432/     15E : 30 3B                       br      nextinstruction                                          ; make re-entrant
     433/     160 :                     
     434/     160 :                     ;****************************************************************************************************************
     435/     160 :                     ;                                                        
     436/     160 :                     ;                                       0aaa run machine code at aaa in P3.
     437/     160 :                     ;                                                        
     438/     160 :                     ;****************************************************************************************************************
     439/     160 :                     
     440/     160 :                     opcode0:
     441/     160 : 96                          ghi     r6                                                       ; get R6.1 (1)
     442/     161 : B3                          phi     r3                                                       ; put in R3.1
     443/     162 : 45                          lda     r5                                                       ; read instruction second byte.
     444/     163 : 30 5C                       br      execr3                                                   
     445/     165 :                     ;   
     446/     165 :                     ;   R8 points here. Calls the $02 <next byte> running in RC.
     447/     165 :                     ;   
     448/     165 :                     exit02call:
     449/     165 : DC                          sep     rc                                                       ; return.
     450/     166 :                     call02:
     451/     166 : 43                          lda     r3                                                       ; read next byte in code
     452/     167 : AC                          plo     rc                                                       ; save in RC.0
     453/     168 : F8 02                       ldi     02                                                       ; put 2xx in RC
     454/     16A : BC                          phi     rc                                                       
     455/     16B : 30 65                       br      exit02call                                               ; and call it, making it re-entrant
     456/     16D :                     ;   
     457/     16D :                     ;   R8 routines to return RF.1, RF.0.
     458/     16D :                     ;   
     459/     16D :                     exitghirf:
     460/     16D : DC                          sep     rc                                                       ; get RF.1
     461/     16E :                     ghirf:
     462/     16E : 9F                          ghi     rf                                                       
     463/     16F : 30 6D                       br      exitghirf                                                
     464/     171 :                     ;   
     465/     171 :                     exitglorf:
     466/     171 : DC                          sep     rc                                                       ; get RF.0
     467/     172 :                     glorf:
     468/     172 : 8F                          glo     rf                                                       
     469/     173 : 30 71                       br      exitglorf                                                
     470/     175 :                     
     471/     175 :                     ;****************************************************************************************************************
     472/     175 :                     ;                                                        
     473/     175 :                     ;                                     Exaa - execute code at 01aa with X = 6
     474/     175 :                     ;                                                        
     475/     175 :                     ;****************************************************************************************************************
     476/     175 :                     
     477/     175 :                     instructione:
     478/     175 : D8                          sep     r8                                                       ; load A and B into RA and RB
     479/     176 : 73                          db      readabregs & 255                                         
     480/     177 : E6                          sex     r6                                                       ; index is Vx
     481/     178 : 45                          lda     r5                                                       ; get the 2nd instruction byte
     482/     179 : A3                          plo     r3                                                       ; and go there, jump indirect.
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 12 - 7/13/2016 18:52:29


     483/     17A :                     ;   
     484/     17A :                     ;   Ex7A . Hex keypad on, wait for byte
     485/     17A :                     ;   
     486/     17A : D8                          sep     r8                                                       ; call hex keypad on at $0246
     487/     17B : 46                          db      keypadon & 255                                           
     488/     17C :                     waitkeypress:
     489/     17C : 3C 7C                       bn1     waitkeypress                                             ; wait for EF1 (byte ready)
     490/     17E :                     readkeyinput:
     491/     17E : 68                          db      68h+keypadport                                           ; read to M(X) (AS Cannot assemble INP0)
     492/     17F : D4                          sep     r4                                                       
     493/     180 :                     ;   
     494/     180 :                     ;   Ex80 . Hex keypad on, byte ready input else skip
     495/     180 :                     ;   
     496/     180 : D8                          sep     r8                                                       ; call hex keypad on at $0246
     497/     181 : 46                          db      keypadon & 255                                           
     498/     182 : 34 7E                       b1      readkeyinput                                             ; if byte ready get it.
     499/     184 :                     skipinstruction:
     500/     184 : 15                          inc     r5                                                       ; skip instruction
     501/     185 : 15                          inc     r5                                                       
     502/     186 : D4                          sep     r4                                                       
     503/     187 :                     ;   
     504/     187 :                     ;   Ex87 - EF2 Skip
     505/     187 :                     ;   
     506/     187 : 35 84                       b2      skipinstruction                                          ; skip if  EF2
     507/     189 : D4                          sep     r4                                                       
     508/     18A :                     ;   
     509/     18A :                     ;   Ex8A - EF3 Skip
     510/     18A :                     ;   
     511/     18A : 36 84                       b3      skipinstruction                                          ; skip if EF3
     512/     18C : D4                          sep     r4                                                       
     513/     18D :                     ;   
     514/     18D :                     ;   Ex8D - Ext Bus to Vx
     515/     18D :                     ;   
     516/     18D : 6E                          inp     externalbus                                              ; read port 6 input.
     517/     18E : D4                          sep     r4                                                       
     518/     18F :                     ;   
     519/     18F :                     ;   Ex8F - Vx to Ext Bus
     520/     18F :                     ;   
     521/     18F : 66                          out     externalbus                                              ; out to port 6
     522/     190 : D4                          sep     r4                                                       
     523/     191 :                     ;   
     524/     191 :                     ;   Ex91 - Write Vx to External Control Register
     525/     191 :                     ;   
     526/     191 : 64                          out     externalcontrol                                          ; external control register
     527/     192 : D4                          sep     r4                                                       
     528/     193 :                     ;   
     529/     193 :                     ;   E093 - Read tape -> M(A) concurrent using DMA Off. Need to turn TV off and Start tape before.
     530/     193 :                     ;   to check tape end read check EF2.
     531/     193 :                     ;   
     532/     193 : 9A                          ghi     ra                                                       ; put RA in R0
     533/     194 : B0                          phi     r0                                                       
     534/     195 : 8A                          glo     ra                                                       
     535/     196 : A0                          plo     r0                                                       
     536/     197 : E3                          sex     r3                                                       ; X = P = 3
     537/     198 : 61                          out     selectdevice                                             ; select tape
     538/     199 : 03                          db      devtape                                                  
     539/     19A : 62                          out     controldevice                                            ; tape read
     540/     19B : 20                          db      ctaperead                                                
     541/     19C : D4                          sep     r4                                                       
     542/     19D :                     ;   
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 13 - 7/13/2016 18:52:29


     543/     19D :                     ;   R1(0)  -> Vx
     544/     19D :                     ;   
     545/     19D : 90                          ghi     r0                                                       
     546/     19E : 56                          str     r6                                                       
     547/     19F : D4                          sep     r4                                                       
     548/     1A0 :                     ;   
     549/     1A0 :                     ;   E3A0 - Write tape from M(A) to M(06FF). Need to turn TV off and start tape before.
     550/     1A0 :                     ;   
     551/     1A0 : 86                          glo     r6                                                       ; read 3  (why E3A0)
     552/     1A1 : BE                          phi     re                                                       
     553/     1A2 :                     tapebyteoutloop:
     554/     1A2 : 93                          ghi     r3                                                       ; get R3.1 which is 1 (we are in R3)
     555/     1A3 : F6                          shr                                                              ; set DF = 1 D = 0. DF set for writing start
     556/     1A4 : AB                          plo     rb                                                       ; save in RB.0 (parity)
     557/     1A5 : F8 08                       ldi     8                                                        ; bits to do.
     558/     1A7 : AE                          plo     re                                                       ; save in RE.0
     559/     1A8 : 4A                          lda     ra                                                       ; read next byte
     560/     1A9 : BB                          phi     rb                                                       ; save in RB.0
     561/     1AA : D8                          sep     r8                                                       ; write start bit
     562/     1AB : 85                          db      writetapedelay & 255                                     
     563/     1AC :                     tapebitoutloop:
     564/     1AC : 9B                          ghi     rb                                                       ; get the byte value
     565/     1AD : F6                          shr                                                              ; put LSB in DF
     566/     1AE : BB                          phi     rb                                                       ; write it back
     567/     1AF : DC                          sep     rc                                                       ; write out DF 0/1.
     568/     1B0 : 2E                          dec     re                                                       ; decrement bit counter
     569/     1B1 : 8E                          glo     re                                                       ; if non zero go back and do next bit.
     570/     1B2 : 3A AC                       bnz     tapebitoutloop                                           
     571/     1B4 : 8B                          glo     rb                                                       ; get the parity count
     572/     1B5 : F6                          shr                                                              ; shift into DF
     573/     1B6 : DC                          sep     rc                                                       ; write that parity bit out
     574/     1B7 : 8A                          glo     ra                                                       ; check done whole page
     575/     1B8 : 3A A2                       bnz     tapebyteoutloop                                          ; if not keep going
     576/     1BA : 9A                          ghi     ra                                                       ; done to $0700 ($06FF last)
     577/     1BB : FB 07                       xri     7                                                        ; (700 is video ram)
     578/     1BD : 3A A2                       bnz     tapebyteoutloop                                          ; if not keep going
     579/     1BF : D4                          sep     r4                                                       
     580/     1C0 :                     
     581/     1C0 :                     ;****************************************************************************************************************
     582/     1C0 :                     ;                                                        
     583/     1C0 :                     ;                                            Instruction vector tables
     584/     1C0 :                     ;                                                        
     585/     1C0 :                     ;****************************************************************************************************************
     586/     1C0 :                     
     587/     1C0 :                     instructionvector:
     588/     1C0 : 00                          db      0                                                        ; 0xxx not decoded here
     589/     1C1 : 02                          db      opcode1 / 256                                            ; 1mmm Do program at mmm (subroutine call)
     590/     1C2 : 02                          db      opcode2 / 256                                            ; 2xkk Load kk into Vx
     591/     1C3 : 02                          db      opcode3 / 256                                            ; 3xkk Skip if Vx != kk
     592/     1C4 : 02                          db      opcode4 / 256                                            ; 4xkk Vx = Random Number & kk
     593/     1C5 : 02                          db      opcode5 / 256                                            ; 5xkk Vx = Vx + kk,skip if vx = 0
     594/     1C6 : 02                          db      opcode6 / 256                                            ; 6xxx Assorted
     595/     1C7 : 00                          db      opcode7 / 256                                            ; 7xnn Assorted
     596/     1C8 : 02                          db      opcode8 / 256                                            ; 8xyf Arithmetic
     597/     1C9 : 02                          db      opcode9 / 256                                            ; 9xys Display pattern
     598/     1CA : 02                          db      instructiona / 256                                       ; Ammm Load A immediate
     599/     1CB : 02                          db      instructionb / 256                                       ; Bmmm Load B immediate
     600/     1CC : 02                          db      instructionc / 256                                       ; Cxy0 Skip if vx != vy
     601/     1CD : 02                          db      instructiond / 256                                       ; Dxy0 Vx Tone, Vy Delay (Tape on spk off)
     602/     1CE : 01                          db      instructione / 256                                       ; Exxx Assorted
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 14 - 7/13/2016 18:52:29


     603/     1CF : 02                          db      instructionf / 256                                       ; Fmmm Jump to mmm
     604/     1D0 :                     
     605/     1D0 : 00                          db      0                                                        ; 0aaa is not dispatched this way.
     606/     1D1 :                     
     607/     1D1 : 0D                          db      opcode1 & 255                                            ; instruction tables (low address)
     608/     1D2 : 81                          db      opcode2 & 255                                            
     609/     1D3 : 23                          db      opcode3 & 255                                            
     610/     1D4 : CA                          db      opcode4 & 255                                            
     611/     1D5 : 1A                          db      opcode5 & 255                                            
     612/     1D6 : 58                          db      opcode6 & 255                                            
     613/     1D7 : 19                          db      opcode7 & 255                                            
     614/     1D8 : 99                          db      opcode8 & 255                                            
     615/     1D9 : DD                          db      opcode9 & 255                                            
     616/     1DA : 00                          db      instructiona & 255                                       
     617/     1DB : 09                          db      instructionb & 255                                       
     618/     1DC : 2B                          db      instructionc & 255                                       
     619/     1DD : BE                          db      instructiond & 255                                       
     620/     1DE : 75                          db      instructione & 255                                       
     621/     1DF : 15                          db      instructionf & 255                                       
     622/     1E0 :                     
     623/     1E0 :                     stack:
     624/     1E0 : 00 00 00 00                 db      0,0,0,0                                                  ; stack space
     625/     1E4 : 00 00 00 00                 db      0,0,0,0                                                  
     626/     1E8 : 00 00 00 00                 db      0,0,0,0                                                  
     627/     1EC : 00 00 00 00                 db      0,0,0,0                                                  
     628/     1F0 : 00 00 00 00                 db      0,0,0,0                                                  
     629/     1F4 : 00 00 00 00                 db      0,0,0,0                                                  
     630/     1F8 : 00 00 00 00                 db      0,0,0,0                                                  
     631/     1FC : 00 00 00                    db      0,0,0                                                    
     632/     1FF :                     stacktop:
     633/     1FF : 00                          db      0                                                        
     634/     200 :                     
     635/     200 :                     ;****************************************************************************************************************
     636/     200 :                     ;                                                        
     637/     200 :                     ;                                              Ammm  Load A with mmm
     638/     200 :                     ;                                                        
     639/     200 :                     ;****************************************************************************************************************
     640/     200 :                     
     641/     200 :                     instructiona:
     642/     200 : F8 10                       ldi     areg & 255                                               ; point R7 to A
     643/     202 :                     loadaddrconst:
     644/     202 : A7                          plo     r7                                                       
     645/     203 : 86                          glo     r6                                                       ; get X address $10X so its $0X
     646/     204 : 57                          str     r7                                                       ; write to A high and point to low
     647/     205 : 17                          inc     r7                                                       
     648/     206 : 45                          lda     r5                                                       ; get second byte of instruction
     649/     207 : 57                          str     r7                                                       ; write to low byte
     650/     208 : D4                          sep     r4                                                       
     651/     209 :                     
     652/     209 :                     ;****************************************************************************************************************
     653/     209 :                     ;                                                        
     654/     209 :                     ;                                              Bmmm  Load B with mmm
     655/     209 :                     ;                                                        
     656/     209 :                     ;****************************************************************************************************************
     657/     209 :                     
     658/     209 :                     instructionb:
     659/     209 : F8 12                       ldi     breg & 255                                               ; point R7 to B and reuse code above
     660/     20B : 30 02                       br      loadaddrconst                                            
     661/     20D :                     
     662/     20D :                     ;****************************************************************************************************************
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 15 - 7/13/2016 18:52:29


     663/     20D :                     ;                                                        
     664/     20D :                     ;                                      1mmm Do Program (Subroutine) at mmmm
     665/     20D :                     ;                                                        
     666/     20D :                     ;****************************************************************************************************************
     667/     20D :                     
     668/     20D :                     opcode1:
     669/     20D : 15                          inc     r5                                                       ; r5 point sto next instruction
     670/     20E : 85                          glo     r5                                                       ; get return address low
     671/     20F : 22                          dec     r2                                                       ; push on stack
     672/     210 : 52                          str     r2                                                       
     673/     211 : 95                          ghi     r5                                                       ; get return address high
     674/     212 : 22                          dec     r2                                                       ; push on stack
     675/     213 : 52                          str     r2                                                       
     676/     214 : 25                          dec     r5                                                       ; point R5 to low byte and fall through.
     677/     215 :                     
     678/     215 :                     ;****************************************************************************************************************
     679/     215 :                     ;                                                        
     680/     215 :                     ;                                           Fmmm Go to program at mmmm
     681/     215 :                     ;                                                        
     682/     215 :                     ;****************************************************************************************************************
     683/     215 :                     
     684/     215 :                     instructionf:
     685/     215 : 45                          lda     r5                                                       ; get low byte
     686/     216 : A5                          plo     r5                                                       ; put in FEL PC Low
     687/     217 : 86                          glo     r6                                                       ; get X address $10X so this is $0X
     688/     218 : B5                          phi     r5                                                       ; put in FEL PC hight
     689/     219 : D4                          sep     r4                                                       
     690/     21A :                     
     691/     21A :                     ;****************************************************************************************************************
     692/     21A :                     ;                                                        
     693/     21A :                     ;                                         5xkk add kk to vx, skip if zero
     694/     21A :                     ;                                                        
     695/     21A :                     ;****************************************************************************************************************
     696/     21A :                     
     697/     21A :                     opcode5:
     698/     21A : E6                          sex     r6                                                       ; access VX
     699/     21B : 45                          lda     r5                                                       ; read 2nd byte
     700/     21C : F4                          add                                                              ; add to VX
     701/     21D : 56                          str     r6                                                       ; write back
     702/     21E : 32 28                       bz      skipinstruction2                                         ; if zero skip
     703/     220 : D4                          sep     r4                                                       
     704/     221 : 15                          inc     r5                                                       ; unused
     705/     222 : D4                          sep     r4                                                       ; unused
     706/     223 :                     
     707/     223 :                     ;****************************************************************************************************************
     708/     223 :                     ;                                                        
     709/     223 :                     ;                                       3xkk  Skip instruction if vx != kk
     710/     223 :                     ;                                                        
     711/     223 :                     ;****************************************************************************************************************
     712/     223 :                     
     713/     223 :                     opcode3:
     714/     223 : 45                          lda     r5                                                       ; get kk value
     715/     224 :                     skipifvxnotd:
     716/     224 : E6                          sex     r6                                                       ; R[X] points to Vx
     717/     225 : F3                          xor                                                              ; compare the values
     718/     226 : 32 2A                       bz      dontskip                                                 ; exit if same
     719/     228 :                     skipinstruction2:
     720/     228 : 15                          inc     r5                                                       ; skip
     721/     229 : 15                          inc     r5                                                       
     722/     22A :                     dontskip:
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 16 - 7/13/2016 18:52:29


     723/     22A : D4                          sep     r4                                                       
     724/     22B :                     
     725/     22B :                     ;****************************************************************************************************************
     726/     22B :                     ;                                                        
     727/     22B :                     ;                                             Cxy0  Skip if vx != vy
     728/     22B :                     ;                                                        
     729/     22B :                     ;****************************************************************************************************************
     730/     22B :                     
     731/     22B :                     instructionc:
     732/     22B : 15                          inc     r5                                                       ; ignore second byte
     733/     22C : 47                          lda     r7                                                       ; read Vy
     734/     22D : 30 24                       br      skipifvxnotd                                             ; so now its same as 3xkk
     735/     22F :                     
     736/     22F :                     ;****************************************************************************************************************
     737/     22F :                     ;                                                        
     738/     22F :                     ;                                            Copy Registers onto Stack
     739/     22F :                     ;                                                        
     740/     22F :                     ;****************************************************************************************************************
     741/     22F :                     
     742/     22F : F8 00                       ldi     0                                                        ; point R6 to $100
     743/     231 : A6                          plo     r6                                                       
     744/     232 : 96                          ghi     r6                                                       ; set R7 to $1E0 stack space bottom.
     745/     233 : B7                          phi     r7                                                       
     746/     234 : F8 E0                       ldi     stack & 255                                              
     747/     236 : A7                          plo     r7                                                       
     748/     237 :                     copyregloop:
     749/     237 : 46                          lda     r6                                                       ; read variable data
     750/     238 : 57                          str     r7                                                       ; copy it out.
     751/     239 : 17                          inc     r7                                                       ; next byte
     752/     23A : 87                          glo     r7                                                       
     753/     23B : FB F4                       xri     0f4h                                                     ; copied all 20 bytes of data ?
     754/     23D : 3A 37                       bnz     copyregloop                                              
     755/     23F : D4                          sep     r4                                                       
     756/     240 :                     
     757/     240 :                     ;****************************************************************************************************************
     758/     240 :                     ;                                                        
     759/     240 :                     ;                                            Turn the television off.
     760/     240 :                     ;                                                        
     761/     240 :                     ;****************************************************************************************************************
     762/     240 :                     
     763/     240 : E3                          sex     r3                                                       ; X = 3 (same as P)
     764/     241 : 61                          out     selectdevice                                             ; select TV device (2)
     765/     242 : 02                          db      devtv                                                    
     766/     243 : 62                          out     controldevice                                            ; turn it off
     767/     244 : 00                          db      ctvoff                                                   
     768/     245 : D4                          sep     r4                                                       
     769/     246 :                     
     770/     246 :                     ;****************************************************************************************************************
     771/     246 :                     ;                                                        
     772/     246 :                     ;                                     Turn hex keypad on (probably run in RC)
     773/     246 :                     ;                                                        
     774/     246 :                     ;****************************************************************************************************************
     775/     246 :                     
     776/     246 :                     keypadon:
     777/     246 : EC                          sex     rc                                                       ; X = C
     778/     247 : 61                          out     selectdevice                                             ; select Keypad device (1)
     779/     248 : 01                          db      devkeypad                                                
     780/     249 : 62                          out     controldevice                                            ; turn it on.
     781/     24A : 01                          db      ckeyon                                                   
     782/     24B : E6                          sex     r6                                                       ; set X back and return.
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 17 - 7/13/2016 18:52:29


     783/     24C : D3                          sep     r3                                                       
     784/     24D :                     
     785/     24D :                     ;****************************************************************************************************************
     786/     24D :                     ;                                                        
     787/     24D :                     ;                                                 Shift Vx left 4
     788/     24D :                     ;                                                        
     789/     24D :                     ;****************************************************************************************************************
     790/     24D :                     
     791/     24D :                     shiftvxleft4:
     792/     24D : E6                          sex     r6                                                       ; R(X) now points to Vx
     793/     24E : F0                          ldx                                                              ; get Vx
     794/     24F : F4                          add                                                              ; add it
     795/     250 : 56                          str     r6                                                       ; write back << 1
     796/     251 : F4                          add                                                              ; add it
     797/     252 : 56                          str     r6                                                       ; write back << 2
     798/     253 : F4                          add                                                              ; add it
     799/     254 : 56                          str     r6                                                       ; write back << 3
     800/     255 : F4                          add                                                              ; add it, now << 4
     801/     256 : 56                          str     r6                                                       ; write back to Vx
     802/     257 : D3                          sep     r3                                                       
     803/     258 :                     ;   
     804/     258 :                     ;   Tape Controller - code to write in low part of instruction
     805/     258 :                     ;   
     806/     258 :                     opcode6:
     807/     258 : E5                          sex     r5                                                       ; use R5 as X
     808/     259 : 63                          out     audiocontrol                                             ; write low byte of instruction to port 3
     809/     25A : D4                          sep     r4                                                       ; return
     810/     25B : 00                          db      0                                                        ; unused
     811/     25C :                     
     812/     25C :                     ;****************************************************************************************************************
     813/     25C :                     ;                                                        
     814/     25C :                     ;                                             Turn the television on
     815/     25C :                     ;                                                        
     816/     25C :                     ;****************************************************************************************************************
     817/     25C :                     
     818/     25C : F8 00                       ldi     0                                                        ; set display address to $700
     819/     25E : A0                          plo     r0                                                       
     820/     25F : F8 07                       ldi     screen / 256                                             
     821/     261 : B0                          phi     r0                                                       
     822/     262 : E3                          sex     r3                                                       ; X = 3 (same as P)
     823/     263 : 61                          out     selectdevice                                             ; select TV device (2)
     824/     264 : 02                          db      devtv                                                    
     825/     265 : 62                          out     controldevice                                            ; turn TV on (why 3 ?)
     826/     266 : 03                          db      ctvon                                                    
     827/     267 : D4                          sep     r4                                                       
     828/     268 :                     
     829/     268 :                     ;****************************************************************************************************************
     830/     268 :                     ;                                                        
     831/     268 :                     ;                                               Turn hex keypad off
     832/     268 :                     ;                                                        
     833/     268 :                     ;****************************************************************************************************************
     834/     268 :                     
     835/     268 : E3                          sex     r3                                                       ; X = 3 (Same as P)
     836/     269 : 61                          out     selectdevice                                             ; select keypad device (1)
     837/     26A : 01                          db      devkeypad                                                
     838/     26B : 62                          out     controldevice                                            ; and turn it off
     839/     26C : 00                          db      ckeyoff                                                  
     840/     26D : D4                          sep     r4                                                       
     841/     26E :                     
     842/     26E :                     ;****************************************************************************************************************
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 18 - 7/13/2016 18:52:29


     843/     26E :                     ;                                                        
     844/     26E :                     ;                                             Return from subroutine
     845/     26E :                     ;                                                        
     846/     26E :                     ;****************************************************************************************************************
     847/     26E :                     
     848/     26E : 42                          lda     r2                                                       ; pop high return
     849/     26F : B5                          phi     r5                                                       ; into R5
     850/     270 : 42                          lda     r2                                                       ; same with low
     851/     271 : A5                          plo     r5                                                       
     852/     272 : D4                          sep     r4                                                       ; return.
     853/     273 :                     ;   
     854/     273 :                     ;   Load A and B into RA and RB
     855/     273 :                     ;   
     856/     273 :                     readabregs:
     857/     273 : 96                          ghi     r6                                                       ; RF = $110
     858/     274 : BF                          phi     rf                                                       
     859/     275 : F8 10                       ldi     areg & 255                                               
     860/     277 : AF                          plo     rf                                                       
     861/     278 : 4F                          lda     rf                                                       ; load in A
     862/     279 : BA                          phi     ra                                                       
     863/     27A : 4F                          lda     rf                                                       
     864/     27B : AA                          plo     ra                                                       
     865/     27C : 4F                          lda     rf                                                       ; load in B
     866/     27D : BB                          phi     rb                                                       
     867/     27E : 4F                          lda     rf                                                       
     868/     27F : AB                          plo     rb                                                       
     869/     280 : D3                          sep     r3                                                       
     870/     281 :                     
     871/     281 :                     ;****************************************************************************************************************
     872/     281 :                     ;                                                        
     873/     281 :                     ;                                               2xkk write kk to vX
     874/     281 :                     ;                                                        
     875/     281 :                     ;****************************************************************************************************************
     876/     281 :                     
     877/     281 :                     opcode2:
     878/     281 : 45                          lda     r5                                                       ; read 2nd instruction byte
     879/     282 : 56                          str     r6                                                       ; save in Vx
     880/     283 : D4                          sep     r4                                                       
     881/     284 :                     ;   
     882/     284 :                     ;   Write to tape - delay
     883/     284 :                     ;   
     884/     284 :                     exitwritetape:
     885/     284 : D3                          sep     r3                                                       
     886/     285 :                     writetapedelay:
     887/     285 : F8 14                       ldi     14h                                                      ; set timer counter
     888/     287 : AF                          plo     rf                                                       
     889/     288 :                     writetapedelayloop:
     890/     288 : 2F                          dec     rf                                                       
     891/     289 : 8F                          glo     rf                                                       
     892/     28A : 3A 88                       bnz     writetapedelayloop                                       
     893/     28C : 30 B0                       br      writedfbittape                                           ; next time, it will write 0/1
     894/     28E :                     
     895/     28E :                     ;   
     896/     28E :                     ;   Do tone Vx = Tone VY = Delay
     897/     28E :                     ;   
     898/     28E :                     playtone:
     899/     28E : 46                          lda     r6                                                       ; read X (tone)
     900/     28F : BE                          phi     re                                                       ; store in tone register
     901/     290 : F8 6E                       ldi     ghirf & 255                                              ; set to identify return.
     902/     292 : A6                          plo     r6                                                       
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 19 - 7/13/2016 18:52:29


     903/     293 : 47                          lda     r7                                                       ; read delay time.
     904/     294 : BF                          phi     rf                                                       ; set RF counter.
     905/     295 : D8                          sep     r8                                                       ; call the tone routine.
     906/     296 : BA                          db      tonegeneration & 255                                     
     907/     297 : 15                          inc     r5                                                       ; fetch the 2nd byte
     908/     298 : D4                          sep     r4                                                       
     909/     299 :                     
     910/     299 :                     ;****************************************************************************************************************
     911/     299 :                     ;                                                        
     912/     299 :                     ;                    8xyn  x = x or y (1) x and y (2) x+y(4) x-y (5), V0 is carry / not borrow
     913/     299 :                     ;                                                        
     914/     299 :                     ;****************************************************************************************************************
     915/     299 :                     
     916/     299 :                     opcode8:
     917/     299 : 22                          dec     r2                                                       ; push $D3 on the stack
     918/     29A : F8 D3                       ldi     0d3h                                                     ; (SEP R3)
     919/     29C : 52                          str     r2                                                       
     920/     29D : 22                          dec     r2                                                       
     921/     29E : 45                          lda     r5                                                       ; get the low byte
     922/     29F : F9 F0                       ori     0f0h                                                     ; F1 F2 F4 F5 which are or and + -
     923/     2A1 : 52                          str     r2                                                       ; save on stack
     924/     2A2 : E6                          sex     r6                                                       ; RX points to the Rx value
     925/     2A3 : 47                          lda     r7                                                       ; get the RY value
     926/     2A4 : D2                          sep     r2                                                       ; call the code pushed on the stack
     927/     2A5 : 56                          str     r6                                                       ; save at R6 (Vx)
     928/     2A6 : F8 00                       ldi     0                                                        ; set R6 to point to $100 V0
     929/     2A8 : A6                          plo     r6                                                       
     930/     2A9 : 96                          ghi     r6                                                       ; D = 1
     931/     2AA : 33 AD                       bdf     writedf                                                  ; if DF clear then
     932/     2AC : F6                          shr                                                              ; D = 0
     933/     2AD :                     writedf:
     934/     2AD : 56                          str     r6                                                       ; write DF out to V0
     935/     2AE : D4                          sep     r4                                                       
     936/     2AF :                     
     937/     2AF :                     ;****************************************************************************************************************
     938/     2AF :                     ;                                                        
     939/     2AF :                     ;       Write DF to tape. Sets up R6 to return to tape code, and writes for 2 or 3 cycles depending on DF.
     940/     2AF :                     ;                                                        
     941/     2AF :                     ;****************************************************************************************************************
     942/     2AF :                     
     943/     2AF :                     exitwritebit:
     944/     2AF : D3                          sep     r3                                                       
     945/     2B0 :                     writedfbittape:
     946/     2B0 : F8 72                       ldi     glorf & 255                                              
     947/     2B2 : A6                          plo     r6                                                       
     948/     2B3 : 9C                          ghi     rc                                                       ; D = 2 (write cycles)
     949/     2B4 : 3B B9                       bnf     savecyclesize                                            ; if bit to write zero, skip
     950/     2B6 : 1B                          inc     rb                                                       ; inc parity value in RB.0
     951/     2B7 : FC 03                       adi     3                                                        ; D = 5
     952/     2B9 :                     savecyclesize:
     953/     2B9 : AF                          plo     rf                                                       ; put write value in RF
     954/     2BA :                     
     955/     2BA :                     ;****************************************************************************************************************
     956/     2BA :                     ;                                                        
     957/     2BA :                     ;                        Tone Generate (P = C), RE.1 = Pitch, RF.0 = Cycles to do it for.
     958/     2BA :                     ;                   R6 is set to 72 for read tape and 6E for make tone, which is how it figures
     959/     2BA :                     ;                        out what to do afterwards,this is used for tape and cassette out.
     960/     2BA :                     ;                                                        
     961/     2BA :                     ;****************************************************************************************************************
     962/     2BA :                     
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 20 - 7/13/2016 18:52:29


     963/     2BA :                     tonegeneration:
     964/     2BA : EC                          sex     rc                                                       ; X = P = C
     965/     2BB : 63                          out     audiocontrol                                             ; set External Function Register -> Run
     966/     2BC : 05                          db      aspeakerbit+aconnect                                     ; speaker line
     967/     2BD : 9E                          ghi     re                                                       ; value 3, set in write tape routine for tape
     968/     2BE :                     instructiond:
     969/     2BE : FF 01                       smi     1                                                        ; short delay loop
     970/     2C0 : 3A BE                       bnz     instructiond                                             
     971/     2C2 : 63                          out     audiocontrol                                             ; reset speaker line.
     972/     2C3 : 01                          db      aconnect                                                 
     973/     2C4 : 2F                          dec     rf                                                       ; done it correct number of times
     974/     2C5 : D6                          sep     r6                                                       ; call F0/F1 -> D, identify caller
     975/     2C6 : 3A BA                       bnz     tonegeneration                                           ; tone, go back to tone loop
     976/     2C8 : 30 84                       br      exitwritetape                                            ; tape, go back to tape loop
     977/     2CA :                     
     978/     2CA :                     ;****************************************************************************************************************
     979/     2CA :                     ;                                                        
     980/     2CA :                     ;                                             4xkk  Vx = kk & random
     981/     2CA :                     ;                                                        
     982/     2CA :                     ;****************************************************************************************************************
     983/     2CA :                     
     984/     2CA :                     opcode4:
     985/     2CA : 19                          inc     r9                                                       ; bump and read random lower
     986/     2CB : 89                          glo     r9                                                       
     987/     2CC : A7                          plo     r7                                                       ; R7 = $01<R9.0>
     988/     2CD : E7                          sex     r7                                                       ; X points there, use as randomish data
     989/     2CE : 99                          ghi     r9                                                       ; random high
     990/     2CF : F4                          add                                                              ; R9.1 + Mem[$01<R9.0>]
     991/     2D0 : 22                          dec     r2                                                       ; push on stack
     992/     2D1 : 52                          str     r2                                                       
     993/     2D2 : F6                          shr                                                              ; add to self shifted right
     994/     2D3 : E2                          sex     r2                                                       
     995/     2D4 : F4                          add                                                              
     996/     2D5 : B9                          phi     r9                                                       ; update R9 high
     997/     2D6 : 56                          str     r6                                                       ; save at Vx
     998/     2D7 : E6                          sex     r6                                                       ; RX points to Vx
     999/     2D8 : 45                          lda     r5                                                       ; read low byte (mask)
    1000/     2D9 : F2                          and                                                              ; and with Vx
    1001/     2DA : 56                          str     r6                                                       ; update
    1002/     2DB : 12                          inc     r2                                                       ; fix up stack and exit.
    1003/     2DC : D4                          sep     r4                                                       
    1004/     2DD :                     
    1005/     2DD :                     ;****************************************************************************************************************
    1006/     2DD :                     ;                                                        
    1007/     2DD :                     ;               9xys  Draw sxs pattern (5 or 8) x = pattern address in page 3 y = tv cell address.
    1008/     2DD :                     ;                                                        
    1009/     2DD :                     ;****************************************************************************************************************
    1010/     2DD :                     opcode9:
    1011/     2DD : 45                          lda     r5                                                       ; Get next byte
    1012/     2DE : FA 0F                       ani     0fh                                                      ; look at lower 4 bits which are size
    1013/     2E0 : AF                          plo     rf                                                       ; RF.0 is the number of lines to do.
    1014/     2E1 :                     
    1015/     2E1 :                     ;****************************************************************************************************************
    1016/     2E1 :                     ;                                                        
    1017/     2E1 :                     ;                                                   RF = #lines
    1018/     2E1 :                     ;                                                        
    1019/     2E1 :                     ;****************************************************************************************************************
    1020/     2E1 :                     
    1021/     2E1 : E6                          sex     r6                                                       ; R(x) points to VX
    1022/     2E2 : F0                          ldx                                                              ; read X
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 21 - 7/13/2016 18:52:29


    1023/     2E3 : AA                          plo     ra                                                       ; save in RA.0
    1024/     2E4 : F8 03                       ldi     graphics / 256                                           ; RA is $03[Vx]
    1025/     2E6 : BA                          phi     ra                                                       
    1026/     2E7 :                     
    1027/     2E7 :                     ;****************************************************************************************************************
    1028/     2E7 :                     ;                                                        
    1029/     2E7 :                     ;                  RF = #lines. RA = address of graphic data. Calc address from tv cell address.
    1030/     2E7 :                     ;                       Bits 3,4 are the vertical cell position (0-3, 8 pixels high cell).
    1031/     2E7 :                     ;                       Bits 0,1,2 are the horizontal position. (0-7, 8 pixels wide cell).
    1032/     2E7 :                     ;                                                        
    1033/     2E7 :                     ;****************************************************************************************************************
    1034/     2E7 :                     
    1035/     2E7 : 47                          lda     r7                                                       ; read Y (Cell number)
    1036/     2E8 : AB                          plo     rb                                                       ; RB.0 = Y
    1037/     2E9 : F6                          shr                                                              ; R6 = Y >> 1 << 4 (Y * 8)
    1038/     2EA : 56                          str     r6                                                       ; using shift left function, so bits
    1039/     2EB : D8                          sep     r8                                                       ; 3 and 4 are now in bits 6,7
    1040/     2EC : 4D                          db      shiftvxleft4 & 255                                       
    1041/     2ED : 8B                          glo     rb                                                       ; get original cell number for bits 0-2
    1042/     2EE : F1                          or                                                               ; or with bits 6-7
    1043/     2EF : FA C7                       ani     0c7h                                                     ; remove so only bits 0-2 and bits 6-7
    1044/     2F1 : AB                          plo     rb                                                       
    1045/     2F2 : F8 07                       ldi     screen/256                                               ; set RB.1 = 07<addr>
    1046/     2F4 : BB                          phi     rb                                                       
    1047/     2F5 :                     
    1048/     2F5 :                     copypixeldata:
    1049/     2F5 : 4A                          lda     ra                                                       ; read first byte of data
    1050/     2F6 : 5B                          str     rb                                                       ; write to the screen
    1051/     2F7 : 8B                          glo     rb                                                       ; get low byte of screen address
    1052/     2F8 : FC 08                       adi     08                                                       ; go one row down
    1053/     2FA : AB                          plo     rb                                                       ; update screen address
    1054/     2FB : 2F                          dec     rf                                                       ; decrement line counter.
    1055/     2FC : 8F                          glo     rf                                                       ; check it
    1056/     2FD : 3A F5                       bnz     copypixeldata                                            ; do next row.
    1057/     2FF : D4                          sep     r4                                                       
    1058/     300 :                     
    1059/     300 :                     ;****************************************************************************************************************
    1060/     300 :                     ;                                                        
    1061/     300 :                     ;                  0300 font data. First 16 bytes is offset for 0-9A-F required for the monitor.
    1062/     300 :                     ;                                       Everything after that is optional.
    1063/     300 :                     ;                                                        
    1064/     300 :                     ;****************************************************************************************************************
    1065/     300 :                     
    1066/     300 :                     graphics:
    1067/     300 : 48                          db      graphic0 & 255                                           
    1068/     301 : 10                          db      graphic1 & 255                                           
    1069/     302 : 2E                          db      graphic2 & 255                                           
    1070/     303 : 2A                          db      graphic3 & 255                                           
    1071/     304 : 19                          db      graphic4 & 255                                           
    1072/     305 : 32                          db      graphic5 & 255                                           
    1073/     306 : 44                          db      graphic6 & 255                                           
    1074/     307 : 14                          db      graphic7 & 255                                           
    1075/     308 : 4C                          db      graphic8 & 255                                           
    1076/     309 : 1E                          db      graphic9 & 255                                           
    1077/     30A : 50                          db      graphica & 255                                           
    1078/     30B : 22                          db      graphicb & 255                                           
    1079/     30C : 40                          db      graphicc & 255                                           
    1080/     30D : 26                          db      graphicd & 255                                           
    1081/     30E : 37                          db      graphice & 255                                           
    1082/     30F : 3B                          db      graphicf & 255                                           
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 22 - 7/13/2016 18:52:29


    1083/     310 :                     graphic1:
    1084/     310 : 10                          db      010h                                                     ; ...X....
    1085/     311 : 30                          db      030h                                                     ; ..XX....
    1086/     312 : 10                          db      010h                                                     ; ...X....
    1087/     313 : 10                          db      010h                                                     ; ...X....
    1088/     314 :                     graphic7:
    1089/     314 : 7C                          db      07ch                                                     ; .XXXXX..
    1090/     315 : 08                          db      008h                                                     ; ....X...
    1091/     316 : 10                          db      010h                                                     ; ...X....
    1092/     317 : 20                          db      020h                                                     ; ..X.....
    1093/     318 : 40                          db      040h                                                     ; .X......
    1094/     319 :                     graphic4:
    1095/     319 : 08                          db      008h                                                     ; ....X...
    1096/     31A : 18                          db      018h                                                     ; ...XX...
    1097/     31B : 28                          db      028h                                                     ; ..X.X...
    1098/     31C : 7C                          db      07ch                                                     ; .XXXXX..
    1099/     31D : 08                          db      008h                                                     ; ....X...
    1100/     31E :                     graphic9:
    1101/     31E : 38                          db      038h                                                     ; ..XXX...
    1102/     31F : 44                          db      044h                                                     ; .X...X..
    1103/     320 : 3C                          db      03ch                                                     ; ..XXXX..
    1104/     321 : 04                          db      004h                                                     ; .....X..
    1105/     322 :                     graphicb:
    1106/     322 : 78                          db      078h                                                     ; .XXXX...
    1107/     323 : 24                          db      024h                                                     ; ..X..X..
    1108/     324 : 38                          db      038h                                                     ; ..XXX...
    1109/     325 : 24                          db      024h                                                     ; ..X..X..
    1110/     326 :                     graphicd:
    1111/     326 : 78                          db      078h                                                     ; .XXXX...
    1112/     327 : 44                          db      044h                                                     ; .X...X..
    1113/     328 : 44                          db      044h                                                     ; .X...X..
    1114/     329 : 44                          db      044h                                                     ; .X...X..
    1115/     32A :                     graphic3:
    1116/     32A : 78                          db      078h                                                     ; .XXXX...
    1117/     32B : 04                          db      004h                                                     ; .....X..
    1118/     32C : 18                          db      018h                                                     ; ...XX...
    1119/     32D : 04                          db      004h                                                     ; .....X..
    1120/     32E :                     graphic2:
    1121/     32E : 78                          db      078h                                                     ; .XXXX...
    1122/     32F : 04                          db      004h                                                     ; .....X..
    1123/     330 : 38                          db      038h                                                     ; ..XXX...
    1124/     331 : 40                          db      040h                                                     ; .X......
    1125/     332 :                     graphic5:
    1126/     332 : 7C                          db      07ch                                                     ; .XXXXX..
    1127/     333 : 04                          db      004h                                                     ; .X..
    1128/     334 : 78                          db      078h                                                     ; .XXXX...
    1129/     335 : 04                          db      004h                                                     ; .....X..
    1130/     336 : 78                          db      078h                                                     ; .XXXX...
    1131/     337 :                     graphice:
    1132/     337 : 7C                          db      07ch                                                     ; .XXXXX..
    1133/     338 : 40                          db      040h                                                     ; .X......
    1134/     339 : 7C                          db      07ch                                                     ; .XXXXX..
    1135/     33A : 40                          db      040h                                                     ; .X......
    1136/     33B :                     graphicf:
    1137/     33B : 7C                          db      07ch                                                     ; .XXXXX..
    1138/     33C : 40                          db      040h                                                     ; .X......
    1139/     33D : 7C                          db      07ch                                                     ; .XXXXX..
    1140/     33E : 40                          db      040h                                                     ; .X......
    1141/     33F : 40                          db      040h                                                     ; .X......
    1142/     340 :                     graphicc:
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 23 - 7/13/2016 18:52:29


    1143/     340 : 3C                          db      03ch                                                     ; ..XXXX..
    1144/     341 : 40                          db      040h                                                     ; .X......
    1145/     342 : 40                          db      040h                                                     ; .X......
    1146/     343 : 40                          db      040h                                                     ; .X......
    1147/     344 :                     graphic6:
    1148/     344 : 3C                          db      03ch                                                     ; ..XXXX..
    1149/     345 : 40                          db      040h                                                     ; .X......
    1150/     346 : 78                          db      078h                                                     ; .XXXX...
    1151/     347 : 44                          db      044h                                                     ; .X...X..
    1152/     348 :                     graphic0:
    1153/     348 : 38                          db      038h                                                     ; ..XXX...
    1154/     349 : 44                          db      044h                                                     ; .X...X..
    1155/     34A : 44                          db      044h                                                     ; .X...X..
    1156/     34B : 44                          db      044h                                                     ; .X...X..
    1157/     34C :                     graphic8:
    1158/     34C : 38                          db      038h                                                     ; ..XXX...
    1159/     34D : 44                          db      044h                                                     ; .X...X..
    1160/     34E : 38                          db      038h                                                     ; ..XXX...
    1161/     34F : 44                          db      044h                                                     ; .X...X..
    1162/     350 :                     graphica:
    1163/     350 : 38                          db      038h                                                     ; ..XXX...
    1164/     351 : 44                          db      044h                                                     ; .X...X..
    1165/     352 : 7C                          db      07ch                                                     ; .XXXXX..
    1166/     353 :                     graphich:
    1167/     353 : 44                          db      044h                                                     ; .X...X..
    1168/     354 : 44                          db      044h                                                     ; .X...X..
    1169/     355 : 7C                          db      07ch                                                     ; .XXXXX..
    1170/     356 :                     graphicu:
    1171/     356 : 44                          db      044h                                                     ; .X...X..
    1172/     357 : 44                          db      044h                                                     ; .X...X..
    1173/     358 : 44                          db      044h                                                     ; .X...X..
    1174/     359 : 44                          db      044h                                                     ; .X...X..
    1175/     35A :                     graphicqmark:
    1176/     35A : 38                          db      038h                                                     ; ..XXX...
    1177/     35B : 44                          db      044h                                                     ; .X...X..
    1178/     35C : 08                          db      008h                                                     ; ....X...
    1179/     35D :                     graphicapostrophe:
    1180/     35D : 10                          :       db 010h                                                  ; ...X....
    1181/     35E : 10                          db      010h                                                     ; ...X....
    1182/     35F :                     graphicspace:
    1183/     35F : 00                          db      000h                                                     ; ........
    1184/     360 :                     graphiculine:
    1185/     360 : 00                          db      000h                                                     ; ........
    1186/     361 : 00                          db      000h                                                     ; ........
    1187/     362 :                     graphicminus:
    1188/     362 : 00                          db      000h                                                     ; ........
    1189/     363 : 00                          db      000h                                                     ; ........
    1190/     364 : 7C                          db      07ch                                                     ; .XXXXX..
    1191/     365 : 00                          db      000h                                                     ; ........
    1192/     366 :                     graphicequals:
    1193/     366 : 00                          db      000h                                                     ; ........
    1194/     367 : 7C                          db      07ch                                                     ; .XXXXX..
    1195/     368 : 00                          db      000h                                                     ; ........
    1196/     369 : 7C                          db      07ch                                                     ; .XXXXX..
    1197/     36A : 00                          :       db 000h                                                  ; ........
    1198/     36B : 18                          db      018h                                                     ; ...XX...
    1199/     36C : 00                          db      000h                                                     ; ........
    1200/     36D : 18                          db      018h                                                     ; ...XX...
    1201/     36E : 00                          db      000h                                                     ; ........
    1202/     36F :                     
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 24 - 7/13/2016 18:52:29


    1203/     36F :                     ;****************************************************************************************************************
    1204/     36F :                     ;                                                        
    1205/     36F :                     ;                                              Versions and Changes.
    1206/     36F :                     ;                                                        
    1207/     36F :                     ;                           13/07/2016 First complete and correctly attributed version.
    1208/     36F :                     ;                                                        
    1209/     36F :                     ;****************************************************************************************************************
    1210/     36F :                     
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 25 - 7/13/2016 18:52:29


  symbol table (* = unused):
  ------------------------

 ACONNECT :                       1 - | *ARCHITECTURE :  i386-unknown-win32 - |
 AREG :                         110 C |  ASPEAKERBIT :                    4 - |
 ATAPEBIT :                       2 - |  AUDIOCONTROL :                   3 - |
*BIGENDIAN :                      0 - |  BORROWOCCURRED :                68 C |
*BRANCHEXT :                      0 - |  BREG :                         112 C |
 CALL02 :                       166 C | *CASESENSITIVE :                  0 - |
 CKEYOFF :                        0 - |  CKEYON :                         1 - |
 CLSLOOP :                       7D C | *CONSTPI :        3.141592653589793 - |
 CONTROLDEVICE :                  2 - |  COPYPIXELDATA :                2F5 C |
 COPYREGLOOP :                  237 C |  CTAPEREAD :                     20 - |
 CTVOFF :                         0 - |  CTVON :                          3 - |
*DATE :                   7/13/2016 - |  DECTABLE :                     114 C |
 DEVKEYPAD :                      1 - |  DEVTAPE :                        3 - |
 DEVTV :                          2 - |  DONTSKIP :                     22A C |
 EXECR3 :                       15C C |  EXIT02CALL :                   165 C |
 EXITGHIRF :                    16D C |  EXITGLORF :                    171 C |
 EXITINTERRUPT :                117 C | *EXITWRITEBIT :                 2AF C |
 EXITWRITETAPE :                284 C |  EXTERNALBUS :                    6 - |
 EXTERNALCONTROL :                4 - | *FALSE :                          0 - |
 FELDISPLAY :                    A4 C |  FELNEXT :                       DC C |
 FELPACK :                       E2 C |  FELSHOW :                       E8 C |
 FELSTOP :                       E0 C |  FELWRITETAPE :                  CA C |
*FULLPMMU :                       1 - |  GHIRF :                        16E C |
 GLORF :                        172 C |  GRAPHIC0 :                     348 C |
 GRAPHIC1 :                     310 C |  GRAPHIC2 :                     32E C |
 GRAPHIC3 :                     32A C |  GRAPHIC4 :                     319 C |
 GRAPHIC5 :                     332 C |  GRAPHIC6 :                     344 C |
 GRAPHIC7 :                     314 C |  GRAPHIC8 :                     34C C |
 GRAPHIC9 :                     31E C |  GRAPHICA :                     350 C |
*GRAPHICAPOSTROPHE :            35D C |  GRAPHICB :                     322 C |
 GRAPHICC :                     340 C |  GRAPHICD :                     326 C |
 GRAPHICE :                     337 C | *GRAPHICEQUALS :                366 C |
 GRAPHICF :                     33B C | *GRAPHICH :                     353 C |
*GRAPHICMINUS :                 362 C | *GRAPHICQMARK :                 35A C |
 GRAPHICS :                     300 C | *GRAPHICSPACE :                 35F C |
*GRAPHICU :                     356 C | *GRAPHICULINE :                 360 C |
*HAS64 :                          1 - | *HASDSP :                         0 - |
*HASFPU :                         0 - | *HASPMMU :                        0 - |
*INEXTMODE :                      0 - | *INLWORDMODE :                    0 - |
*INMAXMODE :                      0 - | *INSRCMODE :                      0 - |
 INSTRUCTIONA :                 200 C |  INSTRUCTIONB :                 209 C |
 INSTRUCTIONC :                 22B C |  INSTRUCTIOND :                 2BE C |
 INSTRUCTIONE :                 175 C |  INSTRUCTIONF :                 215 C |
 INSTRUCTIONVECTOR :            1C0 C | *INSUPMODE :                      0 - |
 INTERRUPT :                    119 C |  KEYPADON :                     246 C |
 KEYPADPORT :                     0 - | *LISTON :                         1 - |
 LOADADDRCONST :                202 C | *MACEXP :                         1 - |
*MOMCPU :                      1802 - | *MOMCPUNAME :                  1802 - |
 MONITOR :                       84 C | *NESTMAX :                      100 - |
 NEXTDIGIT :                     58 C |  NEXTINSTRUCTION :              13B C |
 NEXTTIMER :                    131 C |  OPCODE0 :                      160 C |
 OPCODE1 :                      20D C |  OPCODE2 :                      281 C |
 OPCODE3 :                      223 C |  OPCODE4 :                      2CA C |
 OPCODE5 :                      21A C |  OPCODE6 :                      258 C |
 OPCODE7 :                       19 C |  OPCODE8 :                      299 C |
 OPCODE9 :                      2DD C | *PACKING :                        0 - |
*PADDING :                        1 - | *PLAYTONE :                     28E C |
 AS V1.42 Beta [Bld 102] - source file fel.asm - page 26 - 7/13/2016 18:52:29


 R0 :                             0 - |  R1 :                             1 - |
 R2 :                             2 - |  R3 :                             3 - |
 R4 :                             4 - |  R5 :                             5 - |
 R6 :                             6 - |  R7 :                             7 - |
 R8 :                             8 - |  R9 :                             9 - |
 RA :                             A - |  RB :                             B - |
 RC :                             C - |  RD :                             D - |
 RE :                             E - |  READABREGS :                   273 C |
 READKEYINPUT :                 17E C |  REGISTERS :                    100 C |
*RELAXED :                        0 - |  RF :                             F - |
 SAVECYCLESIZE :                2B9 C |  SCREEN :                       700 - |
 SELECTDEVICE :                   1 - |  SETADDRREG :                    2C C |
 SHIFTVXLEFT4 :                 24D C |  SKIPIFVXNOTD :                 224 C |
 SKIPINSTRUCTION :              184 C |  SKIPINSTRUCTION2 :             228 C |
 STACK :                        1E0 C |  STACKTOP :                     1FF C |
*START :                          0 C |  SUBTRACTUNIT :                  5B C |
 TAPEBITOUTLOOP :               1AC C |  TAPEBYTEOUTLOOP :              1A2 C |
 TAPEDELAYLOOP :                 4B C | *TIME :                    18:52:29 - |
 TIMERUPDATELOOP :              129 C |  TONEGENERATION :               2BA C |
*TRUE :                           1 - | *VERSION :                     142F - |
 WAITKEYPRESS :                 17C C |  WRITEDF :                      2AD C |
 WRITEDFBITTAPE :               2B0 C |  WRITETAPEDELAY :               285 C |
 WRITETAPEDELAYLOOP :           288 C |

    159 symbols
     39 unused symbols

 AS V1.42 Beta [Bld 102] - source file fel.asm - page 27 - 7/13/2016 18:52:29


  defined macros:
  ---------------

FEL                                   |

      1 macro

 AS V1.42 Beta [Bld 102] - source file fel.asm - page 28 - 7/13/2016 18:52:29


  codepages:
  ----------

STANDARD (0 changed characters)


0.01 seconds assembly time

   1264 lines source file
   1388 lines incl. macro expansions
      2 passes
      0 errors
      0 warnings
